<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Undercover (QR multi-smartphones)</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:12px;background:#f6f6f6}
    h1{font-size:18px;margin:0 0 10px}
    .panel{background:#fff;border:1px solid #ddd;border-radius:12px;padding:12px;margin:10px 0}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    button{padding:10px 12px;border:0;border-radius:10px;background:#111;color:#fff;font-weight:800}
    button.secondary{background:#e9e9e9;color:#111}
    input{padding:10px;border-radius:10px;border:1px solid #ddd;background:#fff}
    .pill{border:1px solid #ddd;background:#fff;border-radius:999px;padding:6px 10px;font-size:13px}
    .big{font-size:22px;font-weight:900}
    .muted{opacity:.75}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px}
    .card{border:1px solid #ddd;border-radius:12px;background:#fafafa;padding:10px}
    .qr{display:flex;justify-content:center;align-items:center;background:#fff;border:1px solid #ddd;border-radius:12px;padding:8px}
    .list{display:grid;gap:8px}
    .pitem{border:1px solid #ddd;border-radius:12px;background:#fafafa;padding:10px;cursor:pointer}
    .dead{opacity:.55;text-decoration:line-through}
  </style>
</head>
<body>
<h1>üïµÔ∏è Undercover ‚Äî QR multi-smartphones (sans serveur)</h1>

<!-- MODE JOUEUR (quand on ouvre avec ?p=...) -->
<div class="panel" id="playerMode" style="display:none">
  <div class="pill"><b>Mode joueur</b> ‚Äî lis ton r√¥le, puis ferme la page</div>
  <div style="margin-top:10px" class="big" id="pmRole">‚Äî</div>
  <div class="muted" id="pmWord" style="margin-top:6px"></div>
  <div class="panel" style="background:#fafafa">
    <div class="muted" style="font-size:13px">
      ‚úÖ Une fois que tu as lu, <b>ferme</b> la page ou reviens en arri√®re.
    </div>
  </div>
</div>

<!-- MODE MJ (cr√©ation + QR + gestion) -->
<div class="panel" id="hostSetup">
  <div class="pill"><b>Mode MJ</b> ‚Äî cr√©e la partie et affiche les QR</div>

  <div class="row" style="margin-top:10px">
    <div>
      <div class="muted">Joueurs (3‚Äì10)</div>
      <input id="nPlayers" type="number" min="3" max="10" value="8"/>
    </div>
    <div>
      <div class="muted">Undercover</div>
      <input id="nUnder" type="number" min="1" max="4" value="2"/>
    </div>
    <div>
      <div class="muted">Mr White</div>
      <input id="nWhite" type="number" min="0" max="1" value="1"/>
    </div>
  </div>

  <div class="panel" style="background:#fafafa">
    <div class="muted">Paire de mots (proches)</div>
    <div class="row" style="margin-top:8px">
      <input id="wordA" placeholder="Mot des civils" value="Plage" />
      <input id="wordB" placeholder="Mot des undercover" value="Piscine" />
    </div>
    <div class="muted" style="margin-top:8px;font-size:13px">
      Astuce : mots proches (ex : ‚ÄúPlage / Piscine‚Äù, ‚ÄúPizza / Quiche‚Äù‚Ä¶)
    </div>
  </div>

  <div class="row">
    <button onclick="autoConfig()">Auto config</button>
    <button class="secondary" onclick="randomPair()">Mots au hasard</button>
    <button onclick="startHost()">Cr√©er + QR</button>
    <span class="pill" id="setupHint"></span>
  </div>
</div>

<div class="panel" id="qrPanel" style="display:none">
  <div class="row" style="justify-content:space-between">
    <div class="pill"><b>QR codes joueurs</b> ‚Äî chacun scanne le sien</div>
    <button class="secondary" onclick="toggleQr()">Masquer / Afficher</button>
  </div>
  <div class="muted" style="margin-top:8px;font-size:13px">
    üëâ Donne le t√©l√©phone au joueur, il scanne <b>son QR</b> avec l‚Äôappareil photo.
  </div>
  <div id="qrGrid" class="grid" style="margin-top:10px"></div>
</div>

<div class="panel" id="hostGame" style="display:none">
  <div class="row" style="justify-content:space-between">
    <div class="pill"><b>Manche :</b> <span id="round">1</span></div>
    <div class="pill"><b>√âtat :</b> <span id="status">Discussion</span></div>
  </div>

  <div class="panel" style="background:#fafafa">
    <div class="big" id="phaseTitle">üó£Ô∏è Discussion</div>
    <div class="muted" id="phaseText" style="margin-top:6px">
      Chacun donne un indice (un mot/une courte phrase). Puis votez √† l‚Äôoral et √©liminez.
    </div>
    <div class="row" style="margin-top:10px">
      <button onclick="toVote()">Passer au vote</button>
      <button class="secondary" onclick="newRound()">Nouvelle manche</button>
      <button class="secondary" onclick="revealAll()">R√©v√©ler tout (fin)</button>
      <button class="secondary" onclick="restart()">Recommencer</button>
    </div>
  </div>

  <div class="panel">
    <div class="row" style="justify-content:space-between">
      <b>Joueurs (tape pour √©liminer / r√©animer)</b>
      <span class="muted">‚úÖ vivant / ‚ò†Ô∏è √©limin√©</span>
    </div>
    <div class="list" id="playersList" style="margin-top:10px"></div>
  </div>
</div>

<script>
/* --------------------------
   PAIRES DE MOTS
--------------------------- */
const PAIRS = [
  ["Plage","Piscine"], ["Boulangerie","P√¢tisserie"], ["Chat","Chien"],
  ["For√™t","Jungle"], ["Avion","H√©licopt√®re"], ["Pizza","Quiche"],
  ["Football","Rugby"], ["Cin√©ma","Th√©√¢tre"], ["Montagne","Colline"],
  ["Caf√©","Th√©"], ["Voiture","Moto"], ["Livre","Magazine"],
  ["Hiver","No√´l"], ["Sapin","Guirlande"], ["Neige","Glace"],
];

/* --------------------------
   ETAT HOST (MJ)
--------------------------- */
let H = null; // {n,u,w,A,B,roles,alive,round,status,gameOver}

/* --------------------------
   ROUTAGE : mode joueur ?
--------------------------- */
(function boot(){
  const params = new URLSearchParams(location.search);
  const p = params.get("p");  // payload base64
  if(p){
    // Mode joueur
    try{
      const obj = JSON.parse(atob(p));
      document.getElementById("playerMode").style.display="block";
      document.getElementById("hostSetup").style.display="none";
      document.getElementById("qrPanel").style.display="none";
      document.getElementById("hostGame").style.display="none";

      const roleLabel = obj.role==="Civil" ? "üôÇ Civil" : (obj.role==="Undercover" ? "üï∂Ô∏è Undercover" : "‚¨ú Mr White");
      document.getElementById("pmRole").textContent = roleLabel;

      if(obj.role==="Mr White"){
        document.getElementById("pmWord").textContent = "Tu n‚Äôas PAS de mot. Si tu es √©limin√©, tu devras deviner le mot des civils.";
      } else {
        document.getElementById("pmWord").textContent = "Ton mot : " + obj.word;
      }
    } catch(e){
      document.getElementById("playerMode").style.display="block";
      document.getElementById("pmRole").textContent = "Lien invalide";
      document.getElementById("pmWord").textContent = "Demande au MJ de refaire les QR codes.";
    }
  }
})();

/* --------------------------
   OUTILS
--------------------------- */
function clamp(x,min,max){ return Math.max(min, Math.min(max, x)); }
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }
function normalize(s){
  return (s||"").trim().toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"");
}
function randomPair(){
  const [a,b]=PAIRS[Math.floor(Math.random()*PAIRS.length)];
  document.getElementById("wordA").value=a;
  document.getElementById("wordB").value=b;
  document.getElementById("setupHint").textContent=`Paire : ${a} / ${b}`;
}
function autoConfig(){
  const n = clamp(+document.getElementById("nPlayers").value, 3, 10);
  let u=1,w=0;
  if(n===3){ u=1; w=0; }
  else if(n<=5){ u=1; w=1; }
  else if(n<=7){ u=2; w=1; }
  else { u=3; w=1; }
  document.getElementById("nUnder").value=u;
  document.getElementById("nWhite").value=w;
  document.getElementById("setupHint").textContent=`Auto : ${u} Undercover, ${w} Mr White pour ${n} joueurs.`;
}

/* --------------------------
   CREATION PARTIE + QR
--------------------------- */
function startHost(){
  const n = clamp(+document.getElementById("nPlayers").value, 3, 10);
  const u = clamp(+document.getElementById("nUnder").value, 1, 4);
  const w = clamp(+document.getElementById("nWhite").value, 0, 1);
  const A = (document.getElementById("wordA").value||"").trim();
  const B = (document.getElementById("wordB").value||"").trim();

  if(!A || !B || normalize(A)===normalize(B)){
    alert("Choisis 2 mots diff√©rents.");
    return;
  }
  if(u + w >= n){
    alert("Trop d‚Äôimposteurs : il faut au moins 1 civil üôÇ");
    return;
  }
  if(n===3 && w===1){
    alert("√Ä 3 joueurs, √©vite Mr White. Clique Auto config üôÇ");
    return;
  }

  // roles list
  const roles=[];
  for(let i=0;i<u;i++) roles.push({role:"Undercover", word:B});
  for(let i=0;i<w;i++) roles.push({role:"Mr White", word:"(aucun mot)"});
  while(roles.length<n) roles.push({role:"Civil", word:A});
  shuffle(roles);

  H = { n,u,w,A,B,roles, alive:Array.from({length:n},()=>true), round:1, status:"Discussion", gameOver:false };

  document.getElementById("qrPanel").style.display="block";
  document.getElementById("hostGame").style.display="block";

  renderQr();
  renderPlayers();
}

/* --------------------------
   QR GENERATION (sans librairie externe)
   -> QR via API en ligne = NON (√ßa d√©pendrait d‚Äôinternet)
   Ici : on g√©n√®re un "QR-like" ? Non.
   Solution fiable sans d√©pendance : utiliser un QR minimal en SVG via un micro g√©n√©rateur.
   Pour rester simple et robuste, on affiche le lien + un QR via "qrserver.com" si internet.
   Mais tu veux sans serveur : on garde quand m√™me le lien cliquable + option QR si net.
--------------------------- */
function renderQr(){
  const grid=document.getElementById("qrGrid");
  grid.innerHTML="";

  const base = location.origin + location.pathname; // URL GitHub Pages
  for(let i=0;i<H.n;i++){
    const payload = btoa(JSON.stringify(H.roles[i]));
    const url = `${base}?p=${encodeURIComponent(payload)}`;

    const card=document.createElement("div");
    card.className="card";
    card.innerHTML = `<b>Joueur ${i+1}</b><div class="muted" style="font-size:12px;margin-top:6px">Scan ou ouvre le lien :</div>`;
    // QR (option internet) + lien
    const qrWrap=document.createElement("div");
    qrWrap.className="qr";
    // QR via service public (n√©cessite internet). Si pas de net, le lien reste utilisable.
    const img=document.createElement("img");
    img.alt="QR";
    img.style.maxWidth="140px";
    img.style.width="140px";
    img.style.height="140px";
    img.referrerPolicy="no-referrer";
    img.src = `https://api.qrserver.com/v1/create-qr-code/?size=160x160&data=${encodeURIComponent(url)}`;
    qrWrap.appendChild(img);

    const link=document.createElement("div");
    link.style.marginTop="8px";
    link.innerHTML = `<a href="${url}" target="_blank" style="word-break:break-all;font-size:12px">${url}</a>`;

    card.appendChild(qrWrap);
    card.appendChild(link);
    grid.appendChild(card);
  }
}

function toggleQr(){
  const grid=document.getElementById("qrGrid");
  grid.style.display = (grid.style.display==="none") ? "grid" : "none";
}

/* --------------------------
   JEU (host)
--------------------------- */
function toVote(){
  if(!H || H.gameOver) return;
  H.status="Vote";
  document.getElementById("phaseTitle").textContent="üó≥Ô∏è Vote";
  document.getElementById("phaseText").textContent="Votez √† l‚Äôoral. Puis tape le joueur √©limin√© dans la liste.";
  renderPlayers();
}
function newRound(){
  if(!H || H.gameOver) return;
  H.round++;
  H.status="Discussion";
  document.getElementById("phaseTitle").textContent="üó£Ô∏è Discussion";
  document.getElementById("phaseText").textContent="Chacun donne un indice. Puis votez et √©liminez.";
  renderPlayers();
}

function eliminatePlayer(i){
  if(H.gameOver) return;
  if(!H.alive[i]) return;

  H.alive[i]=false;
  const role = H.roles[i].role;

  if(role==="Mr White"){
    const guess = prompt("‚¨ú Mr White √©limin√© ! Devine le mot des civils :");
    if(guess != null){
      if(normalize(guess) === normalize(H.A)){
        alert("üéâ Mr White a devin√© ! Mr White gagne instantan√©ment !");
        H.gameOver=true;
        revealAll();
        return;
      } else {
        alert("‚ùå Mauvaise r√©ponse. Mr White est √©limin√©.");
      }
    } else {
      alert("Mr White annule / ne tente pas. Il est √©limin√©.");
    }
  }

  renderPlayers();
  checkWin();
}

function renderPlayers(){
  if(!H) return;
  document.getElementById("round").textContent=H.round;
  document.getElementById("status").textContent=H.status;

  const list=document.getElementById("playersList");
  list.innerHTML="";
  for(let i=0;i<H.n;i++){
    const div=document.createElement("div");
    div.className="pitem" + (H.alive[i] ? "" : " dead");
    div.innerHTML = `<b>Joueur ${i+1}</b> ‚Äî ${H.alive[i] ? "‚úÖ vivant" : "‚ò†Ô∏è √©limin√©"}`;
    div.onclick=()=>{
      if(H.alive[i]) eliminatePlayer(i);
      else { H.alive[i]=true; renderPlayers(); } // r√©animer si erreur
    };
    list.appendChild(div);
  }
}

function checkWin(){
  if(H.gameOver) return;

  let aliveC=0, aliveU=0, aliveW=0;
  for(let i=0;i<H.n;i++){
    if(!H.alive[i]) continue;
    const r=H.roles[i].role;
    if(r==="Civil") aliveC++;
    if(r==="Undercover") aliveU++;
    if(r==="Mr White") aliveW++;
  }

  if(aliveU+aliveW===0){
    alert("üéâ Les civils gagnent !");
    H.gameOver=true;
    revealAll(); return;
  }
  if(aliveU+aliveW>=aliveC){
    alert("üíÄ Les imposteurs gagnent !");
    H.gameOver=true;
    revealAll(); return;
  }
}

function revealAll(){
  if(!H) return;
  alert(
    "R√©v√©lation :\n\n" +
    H.roles.map((r,i)=>`Joueur ${i+1}: ${r.role} ‚Äî ${r.word}`).join("\n") +
    `\n\nMot civils: ${H.A}\nMot undercover: ${H.B}`
  );
}

function restart(){ location.href = location.origin + location.pathname; }
</script>
</body>
</html>
